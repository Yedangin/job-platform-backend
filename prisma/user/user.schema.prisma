datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "windows", "darwin-arm64", "debian-openssl-3.0.x"]
  output   = "../../generated/prisma-user"
}

// ========================================
// [핵심] users_auth: 로그인 계정 정보
// ========================================
model User {
  id                String          @id @default(cuid()) @map("auth_id")
  email             String          @unique
  password          String?         @map("password_hash")

  // [소셜 로그인] 일반/소셜 통합 관리
  socialProvider    SocialProvider  @default(NONE) @map("social_provider")
  socialProviderId  String?         @map("social_provider_id")

  // [권한 및 상태]
  userType          UserType        @default(INDIVIDUAL) @map("user_type")
  isActive          Boolean         @default(true) @map("is_active")

  // [타임스탬프]
  joinedAt          DateTime        @default(now()) @map("joined_at")
  lastLoginAt       DateTime?       @map("last_login_at")

  // [소프트 삭제]
  deletedAt         DateTime?       @map("deleted_at")
  deleteScheduledAt DateTime?       @map("delete_scheduled_at")

  // [알림 설정 / Notification settings]
  notifSms          Boolean         @default(false) @map("notif_sms")
  notifEmail        Boolean         @default(false) @map("notif_email")
  notifKakao        Boolean         @default(false) @map("notif_kakao")
  notifEnabledAt    DateTime?       @map("notif_enabled_at")
  // [채널별 동의 일시 / Per-channel consent timestamps]
  notifSmsEnabledAt   DateTime?     @map("notif_sms_enabled_at")
  notifEmailEnabledAt DateTime?     @map("notif_email_enabled_at")
  notifKakaoEnabledAt DateTime?     @map("notif_kakao_enabled_at")
  // [마케팅 수신 동의 / Marketing consent]
  marketingConsent    Boolean       @default(false) @map("marketing_consent")
  marketingConsentAt  DateTime?     @map("marketing_consent_at")

  // [관계]
  corporate         CorporateProfile?
  individual        IndividualProfile?
  supportTickets    SupportTicket[]
  resume            Resume?
  visaVerification  VisaVerification?

  @@unique([socialProvider, socialProviderId])
  @@index([email])
  @@index([socialProvider, socialProviderId])
  @@map("users_auth")
}

enum UserType {
  INDIVIDUAL
  CORPORATE
  ADMIN
}

enum SocialProvider {
  NONE
  GOOGLE
  FACEBOOK
  KAKAO
  APPLE
}


// ========================================
// [기업 회원] 프로필 정보
// ========================================
model CorporateProfile {
  companyId               BigInt              @id @default(autoincrement()) @map("company_id")
  authId                  String              @unique @map("auth_id")
  user                    User                @relation(fields: [authId], references: [id], onDelete: Cascade)

  // [1. 기업 정보] (인증 제출 시 입력, 가입 시에는 null)
  bizRegNumber            String?             @unique @map("biz_reg_number")          // 000-00-00000
  companyNameOfficial     String?             @map("company_name_official")
  ceoName                 String?             @map("ceo_name")
  foundingDate            DateTime?           @map("founding_date") @db.Date

  // [2. 채용 담당자 정보]
  managerName             String?             @map("manager_name")
  managerPhone            String?             @map("manager_phone")
  managerEmail            String?             @map("manager_email")

  // [3. 검증 상태 (★ 핵심)]
  verificationStatus      VerificationStatus  @default(PENDING) @map("verification_status")
  verificationMethod      VerificationMethod? @map("verification_method")
  proofDocumentUrl        String?             @map("proof_document_url")

  // [4. 브랜딩 및 노출 정보]
  brandName               String?             @map("brand_name")                    // 예: 맥도날드 강남점
  logoImageUrl            String?             @map("logo_image_url")
  companyIntro            String?             @map("company_intro") @db.Text

  // [5. 업종 및 위치]
  ksicCode                String?             @map("ksic_code")                     // 표준산업분류코드
  addressRoad             String?             @map("address_road")

  // [6. 전문직(E-7) 채용용 확장 정보]
  companySizeType         CompanySizeType     @default(SME) @map("company_size_type")
  employeeCountKorean     Int                 @default(0) @map("employee_count_korean")
  employeeCountForeign    Int                 @default(0) @map("employee_count_foreign")
  annualRevenue           BigInt              @default(0) @map("annual_revenue")

  // [7. 서류 업로드 및 OCR 검증]
  bizRegDocPath           String?             @map("biz_reg_doc_path")
  bizRegDocOrigName       String?             @map("biz_reg_doc_orig_name")
  empCertDocPath          String?             @map("emp_cert_doc_path")
  empCertDocOrigName      String?             @map("emp_cert_doc_orig_name")
  isCeoSelf               Boolean             @default(false) @map("is_ceo_self")
  ceoSelfDeclaredAt       DateTime?           @map("ceo_self_declared_at")
  ceoSelfDeclaredIp       String?             @map("ceo_self_declared_ip")
  ocrVerified             Boolean             @default(false) @map("ocr_verified")
  ocrExtractedBizNo       String?             @map("ocr_extracted_biz_no")

  // [8. 상태]
  isBizVerified           Boolean             @default(false) @map("is_biz_verified")
  lastRejectionReason     String?             @map("last_rejection_reason")
  submittedAt             DateTime?           @map("submitted_at")
  approvedAt              DateTime?           @map("approved_at")

  createdAt               DateTime            @default(now()) @map("created_at")
  updatedAt               DateTime            @updatedAt @map("updated_at")

  // [관계]
  accessLogs              TalentAccessLog[]

  @@map("profiles_corporate")
}

enum VerificationStatus {
  PENDING       // 미제출 (가입 직후 or 거절 후 리셋)
  SUBMITTED     // 제출완료, 심사 대기
  APPROVED      // 승인
  REJECTED      // (미사용 - 거절 시 PENDING으로 되돌림)
}

enum VerificationMethod {
  CEO_MATCH
  CORP_EMAIL
  DOCUMENT_MANUAL
}

enum CompanySizeType {
  SME
  MID
  LARGE
  STARTUP
}

// ========================================
// [개인 회원] 프로필 정보
// ========================================
model IndividualProfile {
  individualId        BigInt              @id @default(autoincrement()) @map("individual_id")
  authId              String              @unique @map("auth_id")
  user                User                @relation(fields: [authId], references: [id], onDelete: Cascade)

  // [1. 기본 신원 정보]
  realName            String              @map("real_name")
  nationality         String              @map("nationality")   // ISO 3자리 (VNM, PHL, UZB)
  birthDate           DateTime            @map("birth_date")    @db.Date
  gender              Gender
  addressRoad         String?             @map("address_road")

  // [2. 비자 정보 - 채용 핵심 필터]
  // visa_type은 optional로 변경 — 해외 거주 외국인은 비자 미보유
  // visa_type changed to optional — overseas foreigners may not hold a visa yet
  visaType            String?             @map("visa_type")     // D-2, E-7, F-2, NONE 등
  visaExpiryDate      DateTime?           @map("visa_expiry_date") @db.Date

  // [3. 구직 선호 조건]
  desiredJobType      DesiredJobType      @default(FULL_TIME) @map("desired_job_type")
  desiredSalary       Int                 @default(0) @map("desired_salary")  // 단위: 만원 / Unit: 만원
  desiredIndustries   String?             @map("desired_industries")          // 쉼표 구분 / Comma-separated
  isOpenToScout       Boolean             @default(true) @map("is_open_to_scout")

  // [4. 역량 요약 (검색 최적화용 캐싱)]
  finalEducationLvl   EducationLevel?     @map("final_education_lvl")
  koreanFluencyLvl    KoreanFluencyLevel? @map("korean_fluency_lvl")
  totalCareerMonths   Int                 @default(0) @map("total_career_months")

  // [5. 파일 및 소개]
  profileImageUrl     String?             @map("profile_image_url")
  resumeFileUrl       String?             @map("resume_file_url")
  portfolioUrl        String?             @map("portfolio_url")
  selfIntro           String?             @map("self_intro") @db.Text

  // [6. 상태 관리]
  isProfileCompleted  Boolean             @default(false) @map("is_profile_completed")

  // ── [7. 진단 엔진용 확장 (P0: 즉시 필요)] ──
  // ── Diagnosis engine extension fields (P0: immediate) ──
  visaSubType             String?             @map("visa_sub_type")              // E-7-1, F-2-7 등 세부비자 / Detailed visa sub-type
  availableAnnualFund     Int                 @default(0) @map("available_annual_fund") // 연간 가용자금(만원) / Annual available fund (만원)
  topikLevel              Int?                @map("topik_level")                // TOPIK 0-6급 / TOPIK level 0-6
  isEthnicKorean          Boolean             @default(false) @map("is_ethnic_korean") // 재외동포 여부 / Ethnic Korean status
  finalGoal               String?             @map("final_goal")                 // employment / degree / permanent_residence / explore
  priorityPreference      String?             @map("priority_preference")        // speed / stability / cost / income
  nativeSpeakerOf         String?             @map("native_speaker_of")          // 모국어 ISO 639-1 (en, zh, vi 등) / Native language ISO code
  professionalLicense     Json?               @map("professional_license")       // 전문자격증 목록 (JSON 배열) / Professional licenses (JSON array)
  legalStayYears          Int?                @map("legal_stay_years")           // 합법 체류 기간(년) / Legal stay duration (years)
  koreaExperienceYears    Int?                @map("korea_experience_years")     // 한국 경력 기간(년) / Korea work experience (years)

  // ── [8. 진단 정밀도 향상 (P1: 다음 스프린트)] ──
  // ── Diagnosis precision fields (P1: next sprint) ──
  topikExpiryDate         DateTime?           @map("topik_expiry_date") @db.Date // TOPIK 유효기간 / TOPIK expiry date
  kiipStage               Int?                @map("kiip_stage")                 // KIIP 0-5단계 / KIIP stage 0-5
  koreanAncestryCountry   String?             @map("korean_ancestry_country")    // 동포출신국 (CHN, RUS, KAZ 등) / Ethnic Korean origin country
  annualIncome            Int?                @map("annual_income")              // 연소득(만원) / Annual income (만원)
  hasCriminalRecord       Boolean             @default(false) @map("has_criminal_record")       // 범죄기록 여부 / Criminal record
  hasImmigrationViolation Boolean             @default(false) @map("has_immigration_violation") // 출입국법 위반 여부 / Immigration violation
  violationCount          Int                 @default(0) @map("violation_count")               // 위반 횟수 / Violation count
  koreaStayMonths         Int                 @default(0) @map("korea_stay_months")             // 한국 체류 기간(월) / Korea stay duration (months)
  currentEmployerMonths   Int                 @default(0) @map("current_employer_months")       // 현 직장 근속(월) / Current employer tenure (months)
  depopulationArea        Boolean             @default(false) @map("depopulation_area")         // 인구감소지역 거주 / Depopulation area resident

  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // [관계 / Relations]
  accessLogs          TalentAccessLog[]
  educations          ProfileEducation[]
  careers             ProfileCareer[]
  languages           ProfileLanguage[]
  diagnosisSessions   DiagnosisSession[]

  @@map("profiles_individual")
}

enum Gender {
  M
  F
}

enum DesiredJobType {
  FULL_TIME
  PART_TIME
  INTERN
}

enum EducationLevel {
  HIGH_SCHOOL
  COLLEGE
  BACHELOR
  MASTER
  DOCTOR
}

enum KoreanFluencyLevel {
  NONE
  BASIC
  INTERMEDIATE
  ADVANCED
  NATIVE
}

model TalentAccessLog {
  accessId    BigInt            @id @default(autoincrement()) @map("access_id")
  corporateId BigInt            @map("corporate_id")
  corporate   CorporateProfile  @relation(fields: [corporateId], references: [companyId])
  individualId BigInt           @map("individual_id")
  individual  IndividualProfile @relation(fields: [individualId], references: [individualId])
  accessedAt  DateTime          @default(now()) @map("accessed_at")

  @@unique([corporateId, individualId])
  @@map("talent_access_logs")
}

// ========================================
// [교육기관 마스터] 대학교 + 어학당 DB
// Educational institutions master: universities + language institutes
// ========================================
model EducationalInstitution {
  id                BigInt                @id @default(autoincrement()) @map("institution_id")
  name              String                @map("name")                          // 서울대학교 언어교육원
  nameEn            String?               @map("name_en")                       // SNU Language Education Institute

  type              InstitutionType       @map("type")

  // [주소 및 좌표 / Address and coordinates]
  address           String                @map("address")                       // 서울특별시 관악구 관악로 1
  addressDetail     String?               @map("address_detail")                // 140동 (언어교육원)
  latitude          Decimal               @map("latitude") @db.Decimal(10, 7)  // 37.4601234
  longitude         Decimal               @map("longitude") @db.Decimal(10, 7) // 126.9520123

  // [메타 정보 / Meta info]
  isMetroArea       Boolean               @default(false) @map("is_metro_area") // 수도권 여부 (거리 제한 90분/60분 구분)
  affiliatedUniversity String?            @map("affiliated_university")         // 어학당의 경우 소속 대학

  // [검색 최적화 / Search optimization]
  searchKeywords    String[]              @map("search_keywords")               // ["서울대", "SNU", "서울대 어학당"]

  isActive          Boolean               @default(true) @map("is_active")
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")

  // [관계 / Relations]
  educations        ProfileEducation[]

  @@index([type])
  @@index([isMetroArea])
  @@map("educational_institutions")
}

enum InstitutionType {
  UNIVERSITY           // 4년제 대학교
  COLLEGE              // 전문대학
  GRADUATE_SCHOOL      // 대학원
  LANGUAGE_INSTITUTE   // 어학당
  VOCATIONAL_SCHOOL    // 직업전문학교
}

// ========================================
// [학력 정보] E-7 비자 핵심 정보
// ========================================
model ProfileEducation {
  eduId             BigInt                      @id @default(autoincrement()) @map("edu_id")
  individualId      BigInt                      @map("individual_id")
  individual        IndividualProfile           @relation(fields: [individualId], references: [individualId], onDelete: Cascade)

  schoolName        String                      @map("school_name")
  majorName         String                      @map("major_name")
  degreeLevel       EducationLevel              @map("degree_level")

  startDate         DateTime                    @map("start_date") @db.Date
  graduationDate    DateTime?                   @map("graduation_date") @db.Date
  graduationStatus  GraduationStatus            @map("graduation_status")

  gpaScore          Decimal?                    @map("gps_score") @db.Decimal(3, 2)

  // [신규] 교육기관 연결 (국내 대학/어학당만) / New: institution reference (Korean institutions only)
  institutionId     BigInt?                     @map("institution_id")
  institution       EducationalInstitution?     @relation(fields: [institutionId], references: [id])

  // [신규] 학교 국가 코드 / New: school country code
  schoolCountry     String                      @default("KR") @map("school_country")  // ISO 3166-1 alpha-2

  // [신규] 증명서 파일 / Certificate document
  certificateFileUrl    String?                 @map("certificate_file_url")
  certificateFileName   String?                 @map("certificate_file_name")
  certificateUploadedAt DateTime?               @map("certificate_uploaded_at")

  // [신규] 증명서 인증 상태 / Verification status
  isVerified            Boolean                 @default(false) @map("is_verified")
  verifiedAt            DateTime?               @map("verified_at")
  verifiedBy            String?                 @map("verified_by")  // admin userId

  @@index([institutionId])
  @@map("profile_educations")
}

enum GraduationStatus {
  GRADUATED
  ATTENDING
  LEAVE
  DROPOUT
}

// ========================================
// [경력 정보]
// ========================================
model ProfileCareer {
  careerId          BigInt              @id @default(autoincrement()) @map("career_id")
  individualId      BigInt              @map("individual_id")
  individual        IndividualProfile   @relation(fields: [individualId], references: [individualId], onDelete: Cascade)

  companyName       String              @map("company_name")
  dutyRole          String              @map("duty_role")
  jobPosition       String?             @map("job_position")

  startDate         DateTime            @map("start_date") @db.Date
  endDate           DateTime?           @map("end_date") @db.Date
  isCurrent         Boolean             @default(false) @map("is_current")

  description       String?             @map("description") @db.Text

  @@map("profile_careers")
}

// ========================================
// [어학 및 자격증] TOPIK 필수
// ========================================
model ProfileLanguage {
  langId            BigInt              @id @default(autoincrement()) @map("lang_id")
  individualId      BigInt              @map("individual_id")
  individual        IndividualProfile   @relation(fields: [individualId], references: [individualId], onDelete: Cascade)

  languageType      String              @map("language_type")        // Korean, English...
  testType          String?             @map("test_type")            // TOPIK, TOEIC...
  scoreLevel        String              @map("score_level")          // 4급, 850점...
  obtainedDate      DateTime?           @map("obtained_date") @db.Date
  expiryDate        DateTime?           @map("expiry_date") @db.Date

  isVerified        Boolean             @default(false) @map("is_verified")

  @@map("profile_languages")
}

// ========================================
// [고객센터] 문의 게시판
// ========================================
model SupportTicket {
  id          BigInt        @id @default(autoincrement()) @map("ticket_id")
  userId      String        @map("user_id")
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  content     String        @db.Text
  status      TicketStatus  @default(OPEN)
  answer      String?       @db.Text
  answeredAt  DateTime?     @map("answered_at")
  createdAt   DateTime      @default(now()) @map("created_at")

  @@index([userId])
  @@index([status])
  @@map("support_tickets")
}

enum TicketStatus {
  OPEN
  ANSWERED
  CLOSED
}

// ========================================
// [활동 로그] Admin 분석용
// ========================================
model ActivityLog {
  id          BigInt   @id @default(autoincrement()) @map("log_id")
  userId      String?  @map("user_id")
  userEmail   String?  @map("user_email")
  userName    String?  @map("user_name")
  userGender  String?  @map("user_gender")
  actionType  String   @map("action_type")
  description String?  @db.Text
  metadata    String?  @db.Text
  ipAddress   String?  @map("ip_address")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([actionType])
  @@index([createdAt])
  @@index([userId])
  @@map("activity_logs")
}

// ========================================
// [비자 유형] 마스터 데이터
// ========================================
model VisaType {
  id          BigInt    @id @default(autoincrement()) @map("visa_type_id")
  code        String    @unique
  nameKo      String    @map("name_ko")
  nameEn      String?   @map("name_en")
  category    String                                  // WORK, STUDY, RESIDENCE, VISIT
  description String?   @db.Text
  isActive    Boolean   @default(true) @map("is_active")

  // [확장] 하위 비자 유형 및 취업 조건 / Sub-type and employment conditions
  parentCode          String?           @map("parent_code")         // "E-7" for E-7-1, null for top-level
  subTypeCode         String?           @map("sub_type_code")       // "1" for E-7-1, "7" for F-2-7
  employmentLevel     EmploymentLevel   @default(PROHIBITED) @map("employment_level")
  maxWorkHoursWeekly  Int?              @map("max_work_hours_weekly")  // 20 for D-2, null = unlimited
  maxStayMonths       Int?              @map("max_stay_months")        // 12 for H-1, 58 for E-9
  renewalPossible     Boolean           @default(false) @map("renewal_possible")
  minAge              Int?              @map("min_age")
  maxAge              Int?              @map("max_age")
  metadata            String?           @db.Text @map("metadata")  // JSON for extra data

  // [신규] 소거형 매칭 엔진 필드 / New: elimination-based matching engine fields
  visaGroup           String?           @map("visa_group")              // 논리 그룹: study, job_seeking, ethnic_korean, non_skilled, residence, working_holiday, short_term, family, professional, diplomatic
  workType            String?           @map("work_type")               // 취업 유형: part_time_permit_required, employment_permit, negative_list, restricted_occupation, unrestricted, limited_hours, specific_activity, special_permit, employer_specific, prohibited
  permitType          String?           @map("permit_type")             // 허가 유형: '체류자격외활동허가', '고용허가', null(자유취업)
  baseWeeklyHours     Int?              @map("base_weekly_hours")       // 기본 주당 허용시간 (null = 무제한) / Base weekly work hours
  weekendHolidayRule  String?           @map("weekend_holiday_rule")    // 주말/공휴일: 'unlimited', 'same_as_weekday', null
  vacationRule        String?           @map("vacation_rule")           // 방학: 'unlimited', 'same_as_weekday', null
  maxWorkplaces       Int?              @default(1) @map("max_workplaces") // 동시 근무 가능 사업장 수 / Max concurrent workplaces
  permitDurationMonths Int?             @map("permit_duration_months")  // 허가 최장 기간(개월) / Max permit duration in months

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  rules                VisaRule[]
  occupationMappings   VisaOccupationMapping[]
  industryMappings     VisaIndustryMapping[]
  countryRestrictions  VisaCountryRestriction[]
  pointCategories      PointSystemCategory[]
  requiredDocuments    VisaRequiredDocument[]

  // [신규] Step 2 관계 / New: Step 2 relations
  hireQuotaRules       HireQuotaRule[]
  prohibitedIndustries ProhibitedIndustry[]
  workHourRules        WorkHourRule[]

  @@index([code])
  @@index([parentCode])
  @@map("visa_types")
}

enum EmploymentLevel {
  FULL         // 자유취업 (F-2, F-5, F-6)
  LIMITED      // 제한취업 - 업종제한 (E-9, H-2)
  PART_TIME    // 시간제한 (D-2 - 주20시간)
  CONDITIONAL  // 조건부 - 고용주한정 (E-7)
  PROHIBITED   // 취업불가 (B-1, B-2, C-3)
}

// ========================================
// [업종 코드] KSIC 표준산업분류 마스터
// ========================================
model IndustryCode {
  id          BigInt    @id @default(autoincrement()) @map("industry_code_id")
  ksicCode    String    @unique @map("ksic_code")
  sectionCode String    @map("section_code")           // 대분류 알파벳 (C, I, J ...)
  nameKo      String    @map("name_ko")
  nameEn      String?   @map("name_en")
  level       Int       @default(5)                    // 1=대, 2=중, 3=소, 4=세, 5=세세
  parentCode  String?   @map("parent_code")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")

  // [신규] 업종 특성 플래그 / New: industry characteristic flags
  isSimpleLabor         Boolean   @default(false) @map("is_simple_labor")          // 단순노무(KSCO 대분류9) 해당 여부 / Simple labor flag
  isEntertainment       Boolean   @default(false) @map("is_entertainment")         // 풍속/유흥업종 여부 / Adult entertainment flag
  isGambling            Boolean   @default(false) @map("is_gambling")              // 사행행위 여부 / Gambling flag
  isGigWork             Boolean   @default(false) @map("is_gig_work")              // 특수형태근로(배달/대리운전) / Gig economy flag
  requiresSafetyTraining Boolean  @default(false) @map("requires_safety_training") // 건설업 안전교육 필수 / Safety training required
  platformTag           String?   @map("platform_tag")                             // 플랫폼 표시용 태그 / UI display tag (restaurant, cafe, factory, etc.)

  visaMappings     VisaIndustryMapping[]
  hireQuotaRules   HireQuotaRule[]

  @@index([sectionCode])
  @@map("industry_codes")
}

// ========================================
// [비자 규칙] 핵심 규칙 엔진 테이블
// ========================================
model VisaRule {
  id              BigInt      @id @default(autoincrement()) @map("rule_id")
  visaTypeId      BigInt      @map("visa_type_id")
  visaType        VisaType    @relation(fields: [visaTypeId], references: [id])

  ruleName        String      @map("rule_name")
  ruleDescription String?     @map("rule_description") @db.Text
  priority        Int         @default(100)
  ruleType        RuleType    @default(ELIGIBILITY) @map("rule_type")

  conditions      String      @db.Text @map("conditions")   // JSON
  actions         String      @db.Text @map("actions")       // JSON

  version         Int         @default(1)
  parentRuleId    BigInt?     @map("parent_rule_id")
  status          RuleStatus  @default(ACTIVE)

  effectiveFrom   DateTime    @map("effective_from")
  effectiveTo     DateTime?   @map("effective_to")

  createdBy       String?     @map("created_by")
  updatedBy       String?     @map("updated_by")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@index([visaTypeId])
  @@index([status, effectiveFrom])
  @@index([ruleType])
  @@map("visa_rules")
}

enum RuleType {
  ELIGIBILITY
  RESTRICTION
  DOCUMENT
  QUOTA
}

enum RuleStatus {
  DRAFT
  ACTIVE
  INACTIVE
  ARCHIVED
}

// ========================================
// [정책 변경 모니터링] 스크래핑 결과
// ========================================
model PolicyChange {
  id                BigInt            @id @default(autoincrement()) @map("policy_change_id")

  sourceSite        String            @map("source_site")
  sourceUrl         String            @map("source_url") @db.Text
  pageTitle         String?           @map("page_title")

  summary           String            @map("summary") @db.Text
  previousContent   String?           @map("previous_content") @db.Text
  currentContent    String?           @map("current_content") @db.Text

  changeType        PolicyChangeType  @default(UNKNOWN) @map("change_type")
  affectedVisaTypes String?           @map("affected_visa_types")
  effectiveDate     DateTime?         @map("effective_date") @db.Date

  reviewStatus      ReviewStatus      @default(PENDING) @map("review_status")
  reviewedBy        String?           @map("reviewed_by")
  reviewedAt        DateTime?         @map("reviewed_at")
  reviewNote        String?           @map("review_note") @db.Text

  draftRuleId       BigInt?           @map("draft_rule_id")
  detectedAt        DateTime          @default(now()) @map("detected_at")
  contentHash       String?           @map("content_hash")

  @@index([sourceSite])
  @@index([reviewStatus])
  @@index([detectedAt])
  @@index([contentHash])
  @@map("policy_changes")
}

enum PolicyChangeType {
  NEW_REGULATION
  AMENDMENT
  REPEAL
  NOTICE
  GUIDELINE
  UNKNOWN
}

enum ReviewStatus {
  PENDING
  REVIEWED
  RULE_DRAFTED
  APPLIED
  DISMISSED
}

// ========================================
// [스크래핑 상태] 사이트별 상태 추적
// ========================================
model ScrapingState {
  id                BigInt    @id @default(autoincrement()) @map("scraping_state_id")
  siteKey           String    @unique @map("site_key")
  siteUrl           String    @map("site_url")
  lastScrapedAt     DateTime? @map("last_scraped_at")
  lastContentHash   String?   @map("last_content_hash")
  lastStatus        String    @default("IDLE") @map("last_status")
  lastError         String?   @map("last_error") @db.Text
  totalChangesFound Int       @default(0) @map("total_changes_found")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@map("scraping_states")
}

// ========================================
// [비자 평가 로그] 규칙 엔진 실행 기록
// ========================================
model VisaEvaluationLog {
  id              BigInt    @id @default(autoincrement()) @map("evaluation_log_id")
  corporateId     BigInt?   @map("corporate_id")
  requestData     String    @map("request_data") @db.Text
  eligibleVisas   String?   @map("eligible_visas") @db.Text
  blockedVisas    String?   @map("blocked_visas") @db.Text
  appliedRuleIds  String?   @map("applied_rule_ids")
  evaluatedAt     DateTime  @default(now()) @map("evaluated_at")
  durationMs      Int?      @map("duration_ms")

  @@index([corporateId])
  @@index([evaluatedAt])
  @@map("visa_evaluation_logs")
}

// ========================================
// [직종 코드] KSCO 한국표준직업분류
// ========================================
model OccupationCode {
  id          BigInt    @id @default(autoincrement()) @map("occupation_code_id")
  kscoCode    String    @unique @map("ksco_code")       // "2221", "9111"
  nameKo      String    @map("name_ko")
  nameEn      String?   @map("name_en")
  level       Int       @default(2)                     // 1=대, 2=중, 3=소, 4=세
  parentCode  String?   @map("parent_code")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")

  visaMappings VisaOccupationMapping[]

  @@index([level])
  @@map("occupation_codes")
}

// ========================================
// [비자-직종 매핑] 비자별 허용/금지 직종
// ========================================
model VisaOccupationMapping {
  id               BigInt          @id @default(autoincrement()) @map("mapping_id")
  visaTypeId       BigInt          @map("visa_type_id")
  visaType         VisaType        @relation(fields: [visaTypeId], references: [id])
  occupationCodeId BigInt          @map("occupation_code_id")
  occupationCode   OccupationCode  @relation(fields: [occupationCodeId], references: [id])
  isAllowed        Boolean         @default(true) @map("is_allowed")    // true=허용, false=금지
  notes            String?         @db.Text

  @@unique([visaTypeId, occupationCodeId])
  @@index([visaTypeId])
  @@map("visa_occupation_mappings")
}

// ========================================
// [비자-업종 매핑] 비자별 허용/금지 업종
// ========================================
model VisaIndustryMapping {
  id                    BigInt        @id @default(autoincrement()) @map("mapping_id")
  visaTypeId            BigInt        @map("visa_type_id")
  visaType              VisaType      @relation(fields: [visaTypeId], references: [id])
  industryCodeId        BigInt        @map("industry_code_id")
  industryCode          IndustryCode  @relation(fields: [industryCodeId], references: [id])
  isAllowed             Boolean       @default(true) @map("is_allowed")
  maxForeignWorkerRatio Float?        @map("max_foreign_worker_ratio")   // 0.2 = 20%
  maxForeignWorkerCount Int?          @map("max_foreign_worker_count")
  notes                 String?       @db.Text

  @@unique([visaTypeId, industryCodeId])
  @@index([visaTypeId])
  @@map("visa_industry_mappings")
}

// ========================================
// [비자-국가 제한] MOU, 워킹홀리데이 등
// ========================================
model VisaCountryRestriction {
  id              BigInt            @id @default(autoincrement()) @map("restriction_id")
  visaTypeId      BigInt            @map("visa_type_id")
  visaType        VisaType          @relation(fields: [visaTypeId], references: [id])
  countryCode     String            @map("country_code")        // ISO 3166-1 alpha-2: PH, VN, CN
  countryNameKo   String            @map("country_name_ko")
  restrictionType CountryRestrictionType @map("restriction_type")
  notes           String?           @db.Text

  @@unique([visaTypeId, countryCode])
  @@index([visaTypeId])
  @@map("visa_country_restrictions")
}

enum CountryRestrictionType {
  ALLOWED         // 허용 국가 (whitelist)
  BLOCKED         // 금지 국가 (blacklist)
  MOU_REQUIRED    // MOU 체결 필수 (E-9)
}

// ========================================
// [점수제 카테고리] F-2-7, E-7-4 등
// ========================================
model PointSystemCategory {
  id            BigInt    @id @default(autoincrement()) @map("category_id")
  visaTypeId    BigInt    @map("visa_type_id")
  visaType      VisaType  @relation(fields: [visaTypeId], references: [id])
  categoryName  String    @map("category_name")       // "나이", "학력"
  categoryCode  String    @map("category_code")       // AGE, EDUCATION, KOREAN, INCOME, SOCIAL
  maxScore      Int       @map("max_score")            // 25, 35, 20, 25, 15
  sortOrder     Int       @default(0) @map("sort_order")

  criteria      PointSystemCriteria[]

  @@unique([visaTypeId, categoryCode])
  @@index([visaTypeId])
  @@map("point_system_categories")
}

// ========================================
// [점수제 세부 기준] 카테고리별 배점 항목
// ========================================
model PointSystemCriteria {
  id            BigInt              @id @default(autoincrement()) @map("criteria_id")
  categoryId    BigInt              @map("category_id")
  category      PointSystemCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  criteriaName  String              @map("criteria_name")     // "18~24세", "박사학위", "TOPIK 6급"
  minValue      Float?              @map("min_value")          // range start (18 for age)
  maxValue      Float?              @map("max_value")          // range end (24 for age)
  matchValue    String?             @map("match_value")        // exact match ("TOPIK6", "DOCTORATE")
  score         Int                                            // 배점
  sortOrder     Int                 @default(0) @map("sort_order")

  @@index([categoryId])
  @@map("point_system_criteria")
}

// ========================================
// [비자별 필요 서류] 구비서류 목록
// ========================================
model VisaRequiredDocument {
  id            BigInt    @id @default(autoincrement()) @map("document_id")
  visaTypeId    BigInt    @map("visa_type_id")
  visaType      VisaType  @relation(fields: [visaTypeId], references: [id])
  documentName  String    @map("document_name")       // "여권사본", "학위증명서"
  documentCode  String    @map("document_code")       // PASSPORT_COPY, DEGREE_CERT
  isRequired    Boolean   @default(true) @map("is_required")  // false = 조건부/선택
  conditionDesc String?   @map("condition_desc")      // "석사 이상 해당"
  sortOrder     Int       @default(0) @map("sort_order")

  @@index([visaTypeId])
  @@map("visa_required_documents")
}

// ========================================
// [고용쿼터 규칙] 비자별 업종별 외국인 고용허용 인원
// Hire quota rules: foreign worker limits per visa-industry combo
// ========================================
model HireQuotaRule {
  id              BigInt      @id @default(autoincrement()) @map("hire_quota_rule_id")
  visaCode        String      @map("visa_code")                  // 비자 코드 (H-2, E-9 등) / Visa code
  visaTypeId      BigInt      @map("visa_type_id")
  visaType        VisaType    @relation(fields: [visaTypeId], references: [id])
  industryCodeId  BigInt      @map("industry_code_id")
  industryCode    IndustryCode @relation(fields: [industryCodeId], references: [id])

  domesticMin     Int         @map("domestic_min")               // 내국인 최소인원 (이상) / Min domestic workers
  domesticMax     Int?        @map("domestic_max")               // 내국인 최대인원 (이하, null=무제한) / Max domestic workers
  foreignQuota    Int         @map("foreign_quota")              // 외국인 허용인원 / Allowed foreign workers

  effectiveFrom   DateTime    @default(now()) @map("effective_from")
  effectiveUntil  DateTime?   @map("effective_until")            // null = 현행 / null = current
  createdAt       DateTime    @default(now()) @map("created_at")

  @@index([visaCode])
  @@index([industryCodeId])
  @@map("hire_quota_rules")
}

// ========================================
// [금지업종] 비자별 일괄 금지 업종 (네거티브 리스트)
// Prohibited industries: visa-level industry blocks (H-2 negative list etc.)
// ========================================
model ProhibitedIndustry {
  id              BigInt      @id @default(autoincrement()) @map("prohibited_industry_id")
  visaCode        String      @map("visa_code")                  // 비자 코드 / Visa code
  visaTypeId      BigInt      @map("visa_type_id")
  visaType        VisaType    @relation(fields: [visaTypeId], references: [id])
  ksicCode        String      @map("ksic_code")                  // KSIC 중분류/소분류 코드 / KSIC code to block
  categoryLevel   String      @map("category_level")             // 'major', 'medium', 'minor', 'detail'

  hasExceptions   Boolean     @default(false) @map("has_exceptions")   // 예외 소분류 존재 여부 / Has exception sub-codes
  exceptionCodes  String?     @map("exception_codes")            // JSON 배열: 예외 허용 코드 / JSON array of exception codes
  reasonKo        String?     @map("reason_ko")                  // 금지 사유 한글 / Reason in Korean
  reasonEn        String?     @map("reason_en")                  // 금지 사유 영문 / Reason in English
  legalBasis      String?     @map("legal_basis")                // 법적 근거 / Legal basis

  effectiveFrom   DateTime    @default(now()) @map("effective_from")
  effectiveUntil  DateTime?   @map("effective_until")
  createdAt       DateTime    @default(now()) @map("created_at")

  @@unique([visaCode, ksicCode])
  @@index([visaCode])
  @@map("prohibited_industries")
}

// ========================================
// [근로시간 규칙] 비자별 시간제취업 상세 규칙
// Work hour rules: detailed part-time work hour rules per visa
// ========================================
model WorkHourRule {
  id              BigInt      @id @default(autoincrement()) @map("work_hour_rule_id")
  visaCode        String      @map("visa_code")                  // D-2, D-4, D-10, H-1 등
  visaTypeId      BigInt      @map("visa_type_id")
  visaType        VisaType    @relation(fields: [visaTypeId], references: [id])

  // 조건 매칭 키 (null = 와일드카드) / Condition matching keys (null = wildcard)
  degreeLevel     String?     @map("degree_level")               // associate, bachelor, master, doctoral
  academicYear    Int?        @map("academic_year")              // 학년 (1~4), null = 전체
  topikLevel      Int?        @map("topik_level")                // 최소 TOPIK 등급
  topikMet        Boolean     @map("topik_met")                  // true=충족 규칙, false=미충족 규칙
  isCertifiedUniv Boolean?    @map("is_certified_univ")          // IEQAS 인증대학 여부
  hasBonus        Boolean     @default(false) @map("has_bonus")  // +5시간 가산 조건 충족 여부

  // 허용시간 / Allowed hours
  weekdayHours    Int         @map("weekday_hours")              // 주중 주당 허용시간
  weekendHoliday  String      @map("weekend_holiday")            // 'unlimited', 'same', 'specific_hours'
  weekendHours    Int?        @map("weekend_hours")              // weekendHoliday='specific_hours'일 때
  vacation        String      @map("vacation")                   // 'unlimited', 'same', 'specific_hours'
  vacationHours   Int?        @map("vacation_hours")

  // 연간 상한 (H-1용) / Annual max (for H-1)
  annualMaxHours  Int?        @map("annual_max_hours")           // H-1: 1300

  priority        Int         @default(0)                        // 높을수록 먼저 적용 / Higher = higher priority
  effectiveFrom   DateTime    @default(now()) @map("effective_from")
  effectiveUntil  DateTime?   @map("effective_until")
  createdAt       DateTime    @default(now()) @map("created_at")

  @@index([visaCode])
  @@map("work_hour_rules")
}

// ========================================
// [비자 전환 경로] 비자 업그레이드/전환 규칙
// Visa transitions: upgrade/lateral/merge paths between visa types
// ========================================
model VisaTransition {
  id              BigInt      @id @default(autoincrement()) @map("visa_transition_id")

  fromVisa        String      @map("from_visa")                  // 출발 비자 / Source visa code
  toVisa          String      @map("to_visa")                    // 도착 비자 / Target visa code

  transitionType  String      @map("transition_type")            // 'upgrade', 'lateral', 'policy_merge', 'downgrade'

  // 필수 조건 (JSON) / Required conditions (JSON)
  conditions      String      @db.Text @map("conditions")
  // {topik_min, degree_min, min_work_years, min_annual_income, scoring_system_id, ...}

  // 점수제 연결 / Scoring system reference
  scoringSystemId BigInt?     @map("scoring_system_id")
  scoringSystem   ScoringSystem? @relation(fields: [scoringSystemId], references: [id])

  // 점수제 면제 조건 / Scoring exemption conditions
  scoringExemptConditions String? @db.Text @map("scoring_exempt_conditions")

  // 전환 후 체류기간 / Post-transition stay period
  grantedStayMonths Int?     @map("granted_stay_months")
  maxExtensions   Int?        @map("max_extensions")

  priority        Int         @default(0)
  isActive        Boolean     @default(true) @map("is_active")
  effectiveFrom   DateTime    @default(now()) @map("effective_from")
  effectiveUntil  DateTime?   @map("effective_until")

  legalBasis      String?     @map("legal_basis")                // 법적 근거 / Legal basis
  noteKo          String?     @db.Text @map("note_ko")           // 참고사항 / Notes
  createdAt       DateTime    @default(now()) @map("created_at")

  @@index([fromVisa])
  @@index([toVisa])
  @@map("visa_transitions")
}

// ========================================
// [점수제 시스템] D-10, E-7-4, F-2-7 등 점수제 비자 시스템 정의
// Scoring systems: point-based visa evaluation systems
// ========================================
model ScoringSystem {
  id              BigInt      @id @default(autoincrement()) @map("scoring_system_id")
  nameKo          String      @map("name_ko")                    // 'F-2-7 점수제', 'E-7-4 K-Point'
  nameEn          String?     @map("name_en")

  totalPoints     Int         @map("total_points")               // 만점 (D-10: 190, E-7-4: 300, F-2-7: 170)
  passPoints      Int         @map("pass_points")                // 합격 점수 (D-10: 60, E-7-4: 200, F-2-7: 80)

  // 추가 합격 조건 (JSON) / Additional pass conditions (JSON)
  additionalPassConditions String? @db.Text @map("additional_pass_conditions")

  isActive        Boolean     @default(true) @map("is_active")
  effectiveFrom   DateTime    @default(now()) @map("effective_from")
  createdAt       DateTime    @default(now()) @map("created_at")

  criteria        ScoringCriteria[]
  transitions     VisaTransition[]

  @@map("scoring_systems")
}

// ========================================
// [점수제 항목] 점수제 세부 평가 항목
// Scoring criteria: individual scoring items within a scoring system
// ========================================
model ScoringCriteria {
  id                  BigInt        @id @default(autoincrement()) @map("scoring_criteria_id")
  scoringSystemId     BigInt        @map("scoring_system_id")
  scoringSystem       ScoringSystem @relation(fields: [scoringSystemId], references: [id])

  category            String                                     // 'basic', 'age', 'education', 'korean', 'income', 'bonus', 'penalty'
  itemNameKo          String        @map("item_name_ko")         // '나이 (25~29세)'
  itemNameEn          String?       @map("item_name_en")

  points              Int                                        // 양수=가점, 음수=감점 / Positive=bonus, Negative=penalty
  maxPointsInCategory Int?          @map("max_points_in_category") // 해당 카테고리 최대 점수

  // 매칭 조건 (JSON) / Match condition (JSON)
  matchCondition      String        @db.Text @map("match_condition")
  // {"field":"age","min":25,"max":29}, {"field":"topik_level","min":5}

  isActive            Boolean       @default(true) @map("is_active")
  createdAt           DateTime      @default(now()) @map("created_at")

  @@index([scoringSystemId])
  @@map("scoring_criteria")
}

// ========================================
// [비자 전환 체인] 전환 경로 시각화용 체인
// Visa transition chains: path visualization (D-2 → D-10 → E-7)
// ========================================
model VisaTransitionChain {
  id              BigInt      @id @default(autoincrement()) @map("visa_transition_chain_id")
  chainNameKo     String      @map("chain_name_ko")              // '유학생 취업 경로'
  chainNameEn     String?     @map("chain_name_en")

  transitionIds   String      @map("transition_ids")             // JSON 배열: [id1, id2, ...] / JSON array of transition IDs
  visaPath        String      @map("visa_path")                  // 'D-2 → D-10 → E-7'
  totalEstimatedYears Float?  @map("total_estimated_years")      // 예상 총 소요 기간 / Est. total years

  descriptionKo   String?     @db.Text @map("description_ko")
  isActive        Boolean     @default(true) @map("is_active")
  createdAt       DateTime    @default(now()) @map("created_at")

  @@map("visa_transition_chains")
}

// ========================================
// [채용 상품] 프리미엄/일반 상품 마스터
// ========================================
model JobProduct {
  id              BigInt      @id @default(autoincrement()) @map("product_id")
  productCode     String      @unique @map("product_code")
  boardType       BoardType   @map("board_type")
  tierType        TierType    @map("tier_type")
  nameKo          String      @map("name_ko")
  originalPrice   Int         @map("original_price")
  discountPrice   Int         @map("discount_price")
  discountPercent Int         @map("discount_percent")
  durationDays    Int         @map("duration_days")
  features        String?     @db.Text @map("features")
  isActive        Boolean     @default(true) @map("is_active")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  orders          JobOrder[]

  @@map("job_products")
}

enum BoardType {
  PART_TIME
  FULL_TIME
}

enum TierType {
  PREMIUM
  STANDARD
}

// ========================================
// [주문/결제] 가격 스냅샷 포함
// ========================================
model JobOrder {
  id              BigInt          @id @default(autoincrement()) @map("order_id")
  orderNo         String          @unique @map("order_no")
  corporateId     BigInt          @map("corporate_id")
  productId       BigInt          @map("product_id")
  product         JobProduct      @relation(fields: [productId], references: [id])

  // ★ 가격 스냅샷 (구매 시점 가격 기록)
  snapshotProductName   String    @map("snapshot_product_name")
  snapshotOriginalPrice Int       @map("snapshot_original_price")
  snapshotDiscountPrice Int       @map("snapshot_discount_price")
  snapshotDiscountPct   Int       @map("snapshot_discount_pct")
  paidAmount            Int       @map("paid_amount")

  // 결제 정보
  paymentStatus   PaymentStatus   @default(PENDING) @map("payment_status")
  pgProvider      String?         @map("pg_provider")
  impUid          String?         @map("imp_uid")
  merchantUid     String?         @unique @map("merchant_uid")
  paidAt          DateTime?       @map("paid_at")
  cancelledAt     DateTime?       @map("cancelled_at")
  cancelReason    String?         @map("cancel_reason")

  // 연결
  jobPostingId    BigInt?         @map("job_posting_id")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  @@index([corporateId])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("job_orders")
}

enum PaymentStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
  FAILED
}

// ========================================
// [채용공고] 비자 중심 채용 시스템
// ========================================
model JobPosting {
  id               BigInt            @id @default(autoincrement()) @map("job_id")
  corporateId      BigInt            @map("corporate_id")
  orderId          BigInt?           @map("order_id")

  boardType        BoardType         @map("board_type")
  tierType         TierType          @default(STANDARD) @map("tier_type")
  title            String
  description      String            @db.Text
  workContentImg   String?           @map("work_content_img")

  status           PostStatus        @default(DRAFT)
  closingDate      DateTime?         @map("closing_date")

  // 비자 (★ 핵심)
  allowedVisas     String            @map("allowed_visas")
  minKoreanLevel   Int               @default(0) @map("min_korean_level")

  // 위치/근무
  displayAddress   String            @map("display_address")
  actualAddress    String            @map("actual_address")
  workIntensity    Intensity         @default(MIDDLE) @map("work_intensity")
  benefits         String?           @db.Text @map("benefits_json")

  // 연락처
  contactName      String            @map("contact_name")
  contactPhone     String            @map("contact_phone")
  contactEmail     String?           @map("contact_email")

  // 지원 방식
  applicationMethod ApplicationMethod @default(PLATFORM) @map("application_method")
  externalUrl       String?          @map("external_url")
  externalEmail     String?          @map("external_email")

  // 면접
  interviewMethod  InterviewType     @default(OFFLINE) @map("interview_method")
  interviewPlace   String?           @map("interview_place")

  // 정규직 세부유형
  employmentSubType EmploymentSubType? @map("employment_sub_type")

  // 프리미엄/노출 관련 / Premium & exposure fields
  expiresAt        DateTime?         @map("expires_at")
  bumpedAt         DateTime?         @map("bumped_at")
  isUrgent         Boolean           @default(false) @map("is_urgent")
  isFeatured       Boolean           @default(false) @map("is_featured")
  featuredUntil    DateTime?         @map("featured_until")
  upgradedAt       DateTime?         @map("upgraded_at")

  // 통계
  viewCount        Int               @default(0) @map("view_count")
  scrapCount       Int               @default(0) @map("scrap_count")
  applyCount       Int               @default(0) @map("apply_count")

  // 관리자 조치
  suspendedAt      DateTime?         @map("suspended_at")
  suspendReason    String?           @map("suspend_reason")
  suspendedBy      String?           @map("suspended_by")

  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  albaAttributes     JobAttributesAlba?
  fulltimeAttributes JobAttributesFulltime?
  applications       JobApplication[]
  scraps             JobScrap[]

  @@index([corporateId])
  @@index([boardType, tierType, status])
  @@index([status, createdAt])
  @@map("job_postings")
}

enum PostStatus {
  DRAFT
  ACTIVE
  CLOSED
  EXPIRED
  SUSPENDED
}

enum EmploymentSubType {
  CONTRACT
  PERMANENT
  INTERNSHIP
}

enum ApplicationMethod {
  PLATFORM
  WEBSITE
  EMAIL
}

enum Intensity {
  UPPER
  MIDDLE
  LOWER
}

enum InterviewType {
  OFFLINE
  ONLINE
}

// ========================================
// [알바 전용 속성]
// ========================================
model JobAttributesAlba {
  jobId         BigInt      @id @map("job_id")
  job           JobPosting  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  hourlyWage    Int         @map("hourly_wage")
  workPeriod    String?     @map("work_period")
  workDaysMask  String      @map("work_days_mask")
  workTimeStart String?     @map("work_time_start")
  workTimeEnd   String?     @map("work_time_end")

  @@map("job_attributes_alba")
}

// ========================================
// [정규직 전용 속성]
// ========================================
model JobAttributesFulltime {
  jobId           BigInt      @id @map("job_id")
  job             JobPosting  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  salaryMin       Int?        @map("salary_min")
  salaryMax       Int?        @map("salary_max")
  experienceLevel String      @map("experience_level")
  educationLevel  String      @map("education_level")

  @@map("job_attributes_fulltime")
}

// ========================================
// [지원] 3가지 방식 지원
// ========================================
model JobApplication {
  id              BigInt            @id @default(autoincrement()) @map("app_id")
  jobId           BigInt            @map("job_id")
  job             JobPosting        @relation(fields: [jobId], references: [id])
  applicantId     String            @map("applicant_id")

  applicationMethod ApplicationMethod @map("application_method")
  status          ApplicationStatus   @default(PENDING)

  coverLetter     String?           @db.Text @map("cover_letter")
  resumeSnapshot  String?           @db.Text @map("resume_snapshot")

  selfReportedAt  DateTime?         @map("self_reported_at")

  interviewDate   DateTime?         @map("interview_date")
  interviewNote   String?           @map("interview_note")

  rejectionReason String?           @map("rejection_reason")
  resultNotifiedAt DateTime?        @map("result_notified_at")

  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  @@unique([jobId, applicantId])
  @@index([applicantId])
  @@index([status])
  @@map("job_applications")
}

enum ApplicationStatus {
  PENDING
  REVIEWING
  INTERVIEW_SCHEDULED
  INTERVIEW_REQUESTED
  COORDINATION_NEEDED
  CONFIRMED
  ACCEPTED
  REJECTED
  CANCELLED
}

// ========================================
// [스크랩/찜]
// ========================================
model JobScrap {
  id          BigInt      @id @default(autoincrement()) @map("scrap_id")
  jobId       BigInt      @map("job_id")
  job         JobPosting  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  userId      String      @map("user_id")
  createdAt   DateTime    @default(now()) @map("created_at")

  @@unique([jobId, userId])
  @@index([userId])
  @@map("job_scraps")
}

// ========================================
// [관리자 조치 로그]
// ========================================
model AdminJobAction {
  id          BigInt          @id @default(autoincrement()) @map("action_id")
  jobId       BigInt          @map("job_id")
  adminId     String          @map("admin_id")
  actionType  AdminActionType @map("action_type")
  reason      String?         @db.Text
  createdAt   DateTime        @default(now()) @map("created_at")

  @@index([jobId])
  @@map("admin_job_actions")
}

enum AdminActionType {
  SUSPEND
  UNSUSPEND
  FORCE_CLOSE
  DELETE
}

// ========================================
// [이력서] 구직자 이력서 (목표 B-pre)
// Resume for job seekers (Goal B-pre)
// ========================================
model Resume {
  id                       BigInt    @id @default(autoincrement()) @map("resume_id")
  userId                   String    @unique @map("user_id")
  user                     User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // [기본 정보 / Basic info]
  nationality              String    @map("nationality")                           // ISO 3166-1 alpha-2 (KR, VN, PH)
  birthDate                DateTime? @map("birth_date") @db.Date

  // [학력 / Education history — JSON array]
  educations               Json?     @map("educations")                            // [{school, major, degree, graduationYear, country}]

  // [경력 / Work experience — JSON array]
  workExperiences          Json?     @map("work_experiences")                      // [{company, role, startDate, endDate, description}]

  // [한국어 능력 / Korean language]
  topikLevel               Int?      @map("topik_level")                           // 0~6
  kiipLevel                Int?      @map("kiip_level")                            // 0~5

  // [자격증 / Certificates — JSON array]
  certificates             Json?     @map("certificates")                          // [{name, issuer, obtainedDate}]

  // [희망 조건 / Job preferences]
  preferredJobTypes        String[]  @map("preferred_job_types")                   // ["FULL_TIME", "PART_TIME"]
  preferredRegions         String[]  @map("preferred_regions")                     // ["서울", "경기"]
  preferredSalary          Int?      @map("preferred_salary")                      // 만원 단위
  preferredEmploymentTypes String[]  @map("preferred_employment_types")            // ["REGULAR", "CONTRACT"]

  // [상태 / Status]
  isComplete               Boolean   @default(false) @map("is_complete")

  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")

  @@map("resumes")
}

// ========================================
// [비자 인증] 외국인등록증 OCR + 수동입력 (목표 B-pre)
// Visa verification via ARC OCR + manual input (Goal B-pre)
// ========================================
model VisaVerification {
  id                         BigInt               @id @default(autoincrement()) @map("verification_id")
  userId                     String               @unique @map("user_id")
  user                       User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  // [비자 정보 / Visa details]
  visaCode                   String               @map("visa_code")                 // E-7, D-2, F-4 등
  visaSubType                String?              @map("visa_sub_type")              // E-7-1, H-2-5 등
  visaExpiryDate             DateTime             @map("visa_expiry_date") @db.Date
  foreignRegistrationNumber  String?              @map("foreign_registration_number") // 외국인등록번호

  // [인증 방식 / Verification method]
  verificationMethod         VisaVerifyMethod     @map("verification_method")
  verificationStatus         VisaVerifyStatus     @default(PENDING) @map("verification_status")

  // [OCR 관련 / OCR data]
  ocrImagePath               String?              @map("ocr_image_path")             // 업로드된 외국인등록증 이미지 경로
  ocrExtractedData           Json?                @map("ocr_extracted_data")          // OCR 추출 원본 데이터

  // [검증 결과 / Verification result]
  verifiedAt                 DateTime?            @map("verified_at")
  rejectionReason            String?              @map("rejection_reason") @db.Text

  createdAt                  DateTime             @default(now()) @map("created_at")
  updatedAt                  DateTime             @updatedAt @map("updated_at")

  @@map("visa_verifications")
}

enum VisaVerifyMethod {
  OCR
  MANUAL
}

enum VisaVerifyStatus {
  PENDING
  SUBMITTED
  VERIFIED
  REJECTED
}

// ========================================
// [진단 세션] 비자 진단 엔진 세션 기록
// Diagnosis session: visa pathway diagnosis records
// ========================================
model DiagnosisSession {
  sessionId           BigInt              @id @default(autoincrement()) @map("session_id")

  // 회원 or 비회원 / Member or anonymous
  userId              String?             @map("user_id")           // FK → users_auth (회원)
  anonymousId         String?             @map("anonymous_id")      // UUID (비회원 — 쿠키/디바이스)

  // 입력/결과 스냅샷 (JSON) / Input/result snapshot
  inputSnapshot       Json                @map("input_snapshot")    // 진단 시점의 입력값 전체
  resultsSnapshot     Json                @map("results_snapshot")  // 엔진 출력 전체 (경로 목록 + 점수)

  // 요약 / Summary
  topPathwayId        String?             @map("top_pathway_id")    // 1순위 추천 경로 ID
  pathwayCount        Int                 @default(0) @map("pathway_count") // 추천 경로 수

  // 전환 추적 / Conversion tracking
  convertedToSignup   Boolean             @default(false) @map("converted_to_signup")
  convertedToPaid     Boolean             @default(false) @map("converted_to_paid")
  userFeedbackScore   Int?                @map("user_feedback_score") // 1-5점

  createdAt           DateTime            @default(now()) @map("created_at")

  // 관계 / Relations
  individual          IndividualProfile?  @relation(fields: [userId], references: [authId])
  clicks              DiagnosisPathwayClick[]

  @@index([userId])
  @@index([anonymousId])
  @@index([topPathwayId])
  @@index([createdAt])
  @@map("diagnosis_sessions")
}

// ========================================
// [경로 클릭 추적] 진단 결과 내 경로 클릭 기록
// Diagnosis pathway click: tracks user interactions with recommended pathways
// ========================================
model DiagnosisPathwayClick {
  clickId             BigInt              @id @default(autoincrement()) @map("click_id")
  sessionId           BigInt              @map("session_id")
  pathwayId           String              @map("pathway_id")       // PW-001, PW-002 등
  rankPosition        Int                 @map("rank_position")    // 표시 순위 (1, 2, 3...)
  actionType          String              @map("action_type")      // view_detail / start_apply / share / dismiss

  createdAt           DateTime            @default(now()) @map("created_at")

  session             DiagnosisSession    @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  @@index([pathwayId])
  @@index([sessionId])
  @@map("diagnosis_pathway_clicks")
}

// ========================================
// [점수 캘리브레이션 로그] 진단 점수 변경 추적
// Score calibration log: tracks diagnosis score adjustments
// ========================================
model ScoreCalibrationLog {
  logId               BigInt              @id @default(autoincrement()) @map("log_id")
  pathwayId           String              @map("pathway_id")       // 경로 ID / Pathway ID
  dimension           String                                       // age / nationality / fund / education
  dimensionValue      String              @map("dimension_value")  // "26-30", "VNM", "500-1000" 등
  oldScore            Decimal             @map("old_score")
  newScore            Decimal             @map("new_score")
  changeReason        String              @map("change_reason")    // auto_calibration / manual
  evidence            Json?                                        // 근거 데이터 (전환율, 샘플수 등)
  changedBy           String?             @map("changed_by")       // system / admin_user_id

  createdAt           DateTime            @default(now()) @map("created_at")

  @@index([pathwayId, dimension])
  @@map("score_calibration_log")
}
