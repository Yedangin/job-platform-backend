// ==========================================================
// 결제 스키마 — 거래정보 (5년 보존)
// Payment schema — transaction data (5-year retention)
// ==========================================================

datasource db {
  provider = "postgresql"
  url      = env("PAYMENT_DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../../generated/prisma-payment"
}

// ==========================================================
// [상품 마스터] 모든 유료 상품 정의
// [Product master] All paid product definitions
// ==========================================================
model Product {
  id          Int             @id @default(autoincrement()) @map("product_id")
  code        String          @unique @map("product_code")
  name        String          @map("product_name")
  nameEn      String          @map("product_name_en")
  category    ProductCategory @map("product_category")
  price       Int             @map("price")
  description String?         @map("description")
  isActive    Boolean         @default(true) @map("is_active")
  metadata    String?         @db.Text @map("metadata")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  orders Order[]

  @@map("products")
}

// 상품 카테고리 / Product category
enum ProductCategory {
  JOB_POSTING
  TALENT_VIEW
  ADDON
}

// ==========================================================
// [주문] 결제 단위
// [Order] Payment unit
// ==========================================================
model Order {
  id             Int         @id @default(autoincrement()) @map("order_id")
  orderNo        String      @unique @map("order_no")
  userId         String      @map("user_id")
  productId      Int         @map("product_id")
  product        Product     @relation(fields: [productId], references: [id])
  targetJobId    BigInt?     @map("target_job_id")
  quantity       Int         @default(1) @map("quantity")
  totalAmount    Int         @map("total_amount")
  originalAmount Int         @map("original_amount")
  couponId       Int?        @map("coupon_id")
  coupon         Coupon?     @relation(fields: [couponId], references: [id])
  status         OrderStatus @default(PENDING) @map("status")

  payment   Payment?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

// 주문 상태 / Order status
enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
  FAILED
}

// ==========================================================
// [결제] 포트원 V2 연동 상세
// [Payment] PortOne V2 integration details
// ==========================================================
model Payment {
  id                Int           @id @default(autoincrement()) @map("payment_id")
  orderId           Int           @unique @map("order_id")
  order             Order         @relation(fields: [orderId], references: [id])
  portonePaymentId  String        @unique @map("portone_payment_id")
  method            PaymentMethod @map("method")
  status            PaymentStatus @default(PENDING) @map("status")
  paidAmount        Int?          @map("paid_amount")
  paidAt            DateTime?     @map("paid_at")
  receiptUrl        String?       @map("receipt_url")
  cardInfo          String?       @db.Text @map("card_info")
  cancelledAmount   Int?          @map("cancelled_amount")
  cancelledAt       DateTime?     @map("cancelled_at")
  cancelReason      String?       @map("cancel_reason")
  webhookData       String?       @db.Text @map("webhook_data")
  failReason        String?       @map("fail_reason")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  @@index([portonePaymentId])
  @@map("payments")
}

// 결제 수단 / Payment method
enum PaymentMethod {
  CARD
  VIRTUAL_ACCOUNT
  EASY_PAY
  TRANSFER
}

// 결제 상태 / Payment status
enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
  PARTIAL_CANCELLED
}

// ==========================================================
// [쿠폰 마스터] 할인/무료 쿠폰 정의
// [Coupon master] Discount/free coupon definitions
// ==========================================================
model Coupon {
  id             Int              @id @default(autoincrement()) @map("coupon_id")
  code           String           @unique @map("coupon_code")
  name           String           @map("coupon_name")
  type           CouponType       @map("coupon_type")
  value          Int              @map("coupon_value")
  targetProduct  ProductCategory? @map("target_product")
  minOrderAmount Int?             @map("min_order_amount")
  maxUses        Int?             @map("max_uses")
  usedCount      Int              @default(0) @map("used_count")
  maxUsesPerUser Int              @default(1) @map("max_uses_per_user")
  startsAt       DateTime         @map("starts_at")
  expiresAt      DateTime         @map("expires_at")
  isActive       Boolean          @default(true) @map("is_active")
  createdAt      DateTime         @default(now()) @map("created_at")

  orders Order[]
  usages CouponUsage[]

  @@map("coupons")
}

// 쿠폰 유형 / Coupon type
enum CouponType {
  FIXED_DISCOUNT
  PERCENT_DISCOUNT
  FREE_ITEM
}

// ==========================================================
// [쿠폰 사용 기록] 사용자별 쿠폰 사용 추적
// [Coupon usage log] Per-user coupon usage tracking
// ==========================================================
model CouponUsage {
  id       Int      @id @default(autoincrement()) @map("usage_id")
  couponId Int      @map("coupon_id")
  coupon   Coupon   @relation(fields: [couponId], references: [id])
  userId   String   @map("user_id")
  usedAt   DateTime @default(now()) @map("used_at")

  @@index([couponId])
  @@index([userId])
  @@map("coupon_usages")
}

// ==========================================================
// [인재 열람권 잔여] 기업별 열람 크레딧 관리
// [Talent viewing credit] Per-company viewing credit balance
// ==========================================================
model ViewingCredit {
  id           Int      @id @default(autoincrement()) @map("credit_id")
  userId       String   @map("user_id")
  totalCredits Int      @map("total_credits")
  usedCredits  Int      @default(0) @map("used_credits")
  source       String   @map("source")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId, expiresAt])
  @@map("viewing_credits")
}

// ==========================================================
// [인재 열람 기록] 열람 차감 추적
// [Talent view log] Viewing deduction tracking
// ==========================================================
model ViewingLog {
  id       Int      @id @default(autoincrement()) @map("log_id")
  userId   String   @map("user_id")
  resumeId BigInt   @map("resume_id")
  creditId Int?     @map("credit_id")
  viewedAt DateTime @default(now()) @map("viewed_at")

  @@index([userId])
  @@index([resumeId])
  @@map("viewing_logs")
}
