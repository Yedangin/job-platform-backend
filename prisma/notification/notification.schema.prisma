// Notification Domain Schema - PostgreSQL
// Includes: notifications, chats, messages

datasource notiDB {
  provider = "postgresql"
  url      = env("NOTIFICATION_DATABASE_URL")
}

generator notiClient {
  provider = "prisma-client-js"
  output   = "../../generated/prisma-notification"
  // binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

enum NotificationType {
  APPLICATION_ALERT
  INTERVIEW_UPDATE
  REMINDER
  PROMOTION
  EMAIL_VERIFICATION
  FINANCIAL_ALERT
  STATUS_ALERT
}

enum NotificationStatus {
  PENDING
  SENDING
  FAILED
}

model Notification {
  id                 String             @id @default(cuid()) @map("id")
  userId             String             @map("user_id")
  email              String?            @notiDB.VarChar(50)
  subject            String?            @notiDB.VarChar(100)
  content            String?
  notificationType   NotificationType   @default(REMINDER) @map("notification_type")
  status             NotificationStatus @default(PENDING)
  priority           Int?
  attempts           Int?
  maxAttempts        Int?               @map("max_attempts")
  metadata           String?
  isRead             Boolean?           @map("is_read")
  relatedInterviewId String?            @map("related_interview_id")
  relatedJobPostId   String?            @map("related_job_post_id")
  createdAt          DateTime           @default(now()) @map("created_at")
  sendedAt           DateTime?          @map("sended_at")
  failedAt           DateTime?          @map("failed_at")
  errorMessage       String?            @map("error_message") @notiDB.Text

  @@index([email])
  @@index([subject])
  @@index([notificationType])
  @@index([metadata])
  @@map("notifications")
}

// --- Chatting Models (Updated) ---

// 1. Represents a single chat room (either 1-on-1 or group).
model Conversation {
  id             String                @id @default(cuid()) @map("id")
  name           String?               @notiDB.VarChar(255) // Only needed for Group chats (optional for 1-on-1)
  isGroup        Boolean               @default(false)      // True for group chats, false for 1-on-1
  createdAt      DateTime              @default(now()) @map("created_at")

  members        ConversationMember[]
  messages       Message[]

  @@map("conversations")
}

// 2. Links Users to Conversations (Many-to-Many Relationship).
// This replaces your old 'Chat' model.
model ConversationMember {
  id             String         @id @default(cuid()) @map("id")
  conversationId String         @map("conversation_id")
  userId         String         @map("user_id") // The user ID for this member
  isAdmin        Boolean        @default(false) // For group management

  conversation   Conversation   @relation(fields: [conversationId], references: [id])

  @@unique([conversationId, userId]) // A user can only be a member once per conversation
  @@map("conversation_members")
}


// 3. Updated to reference the Conversation ID instead of a receiver ID.
model Message {
  id             String     @id @default(cuid()) @map("id")
  conversationId String     @map("conversation_id") // References the chat room/conversation
  senderId       String     @map("sender_id") // The user who sent the message
  message        String?    @notiDB.VarChar(255)
  isSeen         Boolean    @default(false) @map("is_seen")
  createdAt      DateTime   @default(now()) @map("created_at")

  conversation   Conversation @relation(fields: [conversationId], references: [id])

  @@map("messages")
}
